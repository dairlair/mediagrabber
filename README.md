# MediaGrabber

[![codecov](https://codecov.io/gh/dairlair/mediagrabber/branch/master/graph/badge.svg?token=P76Zts58lp)](undefined)

The cloud native application for media grabbing. The application listens the specified queue with AMQP and expects messages in the format:
```json
{"url": "https://abcnews.go.com/Technology/video/california-judge-orders-uber-lyft-reclassify-drivers-employees-72302309"}
```

You can run the faces retrieving with customized params:
```json
{
    "url": "https://abcnews.go.com/Technology/video/california-judge-orders-uber-lyft-reclassify-drivers-employees-72302309",
    "tolerance": 0.45
}
```

## Run, using CLI interface

Before using the MediaGrabber in the cloned repository you need to install [youtube-dl](https://github.com/ytdl-org/youtube-dl#installation).

Create local python environment with:
```sh
python3 -m venv venv
. ./venv/bin/activate
pip install -r requirements.txt
```

Now you can download video from the website with:
```sh
python app/cli/cli.py download "https://abcnews.go.com/Technology/video/california-judge-orders-uber-lyft-reclassify-drivers-employees-72302309"
python app/cli/cli.py download "https://pornhub.com/view_video.php?viewkey=ph5fcea9ba0ae13"
python app/cli/cli.py download "https://www.bloomberg.com/news/videos/2021-03-09/-bloomberg-the-open-full-show-03-09-2021-video"
```

Retrieve and save faces from the downloaded video via:
```sh
python app/cli/cli.py retrieve /home/dairlair/Videos/Constantine.mkv --resize_height=360
```

Or download, retrieve and save faces in one command with (just specify URL instead of existing file):
```sh
python app/cli/cli.py retrieve "https://abcnews.go.com/Technology/video/california-judge-orders-uber-lyft-reclassify-drivers-employees-72302309"
python app/cli/cli.py retrieve "https://pornhub.com/view_video.php?viewkey=ph5fcea9ba0ae13" --resize_height=180
```

### Download video, retrieve faces and calculate embeddings

```
python app/cli/cli.py memorize "https://www.pornhub.com/view_video.php?viewkey=ph5fd7bc93973ad" video test 1 publication
```

Elasticsearch index for memorizing:
```json
PUT /faces
{
  "settings": {
    "number_of_shards": 1
  },
  "mappings": {
    "properties": {
      "externalEntity": {
        "type":  "keyword"
      },
      "externalEntityId": {
        "type":  "keyword"
      },
      "tags": {
        "type":  "keyword"
      },
      "encoding": { "type": "dense_vector", "dims": 128}
    }
  }
}
```

Elasticsearch query for similar faces search:
# Formula for cosine similarity: "source": "cosineSimilarity(params.queryVector, 'encoding') + 1.0",
# Formula for euclidean distance similarity: "source": "cosineSimilarity(params.queryVector, 'encoding') + 1.0",
```json
GET /faces/_search
"query": {
"script_score": {
    "query": {
        "match_all": {}
    },
    "script": {
        
        "source": "1 / (1 + l2norm(params.queryVector, 'encoding'))",
        "params": {
            "queryVector": list([0.021156515926122665, 0.06117333471775055, 0.04895704984664917, -0.08716674894094467, -0.07123435288667679, 0.06320270150899887, -0.11756282299757004, -0.10578637570142746, 0.18885256350040436, -0.17525224387645721, 0.1253783255815506, -0.006149946711957455, -0.275496244430542, 0.03214927390217781, -0.09190399199724197, 0.21522918343544006, -0.14414745569229126, -0.19361554086208344, 0.005793217569589615, -0.036655861884355545, -0.019517621025443077, 0.09415359050035477, -0.03767602890729904, 0.06506793200969696, -0.12210571765899658, -0.34464290738105774, -0.05222218856215477, -0.03062220849096775, -0.04207560420036316, -0.05603121593594551, 0.011562949977815151, 0.14622314274311066, -0.10034722834825516, 0.11775563657283783, 0.08865762501955032, 0.10761109739542007, -0.02625320293009281, -0.1088075041770935, 0.18018624186515808, 0.105057492852211, -0.24528959393501282, -0.10347588360309601, 0.06454315781593323, 0.2813991606235504, 0.1541125774383545, -0.04559847339987755, 0.0390479601919651, -0.08375711739063263, 0.10899924486875534, -0.32864782214164734, 0.04239165037870407, 0.1313054859638214, 0.10788490623235703, 0.1227458044886589, 0.09072663635015488, -0.15892735123634338, 0.06629227101802826, 0.06422336399555206, -0.13669835031032562, -0.015917886048555374, 0.03480060398578644, -0.08512984961271286, 0.02860536240041256, -0.041131582111120224, 0.24887818098068237, 0.03799571841955185, -0.1352052241563797, -0.09624551236629486, 0.19629226624965668, -0.18503883481025696, -0.10390499234199524, 0.05946304649114609, -0.056296493858098984, -0.16661806404590607, -0.2842686176300049, -0.03535795956850052, 0.3140040636062622, 0.2158919870853424, -0.16504907608032227, 0.07304570823907852, -0.007711515761911869, -0.032053060829639435, 0.034228891134262085, 0.16445155441761017, -0.013852888718247414, 0.019792012870311737, -0.019853942096233368, -0.0006108339875936508, 0.2665952146053314, -0.03465386480093002, 0.0017979179974645376, 0.260084867477417, 0.019147954881191254, 0.02749667875468731, 0.007451485842466354, 0.06337335705757141, -0.034983012825250626, -0.007924404926598072, -0.10762432217597961, -0.0025871573016047478, -0.0314791277050972, 0.02237747795879841, 0.01123442966490984, 0.1589754819869995, -0.26329389214515686, 0.21334682404994965, -0.012974954210221767, -0.07321552187204361, 0.06457515060901642, 0.04728178679943085, -0.05814854055643082, -0.07704760879278183, 0.15378428995609283, -0.3043437898159027, 0.07191040366888046, 0.16878291964530945, 0.09168729186058044, 0.14019662141799927, -0.0001177620142698288, 0.06045279651880264, 0.01923784241080284, -0.1560412049293518, -0.16827496886253357, -0.10634513199329376, 0.031001120805740356, -0.07573352009057999, -0.09187111258506775, 0.0380566269159317])
        }
    }
}
}}

GET faces/_search
{
  "query": {
    "script_score": {
      "query" : {
          "match_all": {}
      },
      "script": {
        "source": "cosineSimilarity(params.query_vector, 'encoding') + 1.0", 
        "params": {
          "query_vector": [0.021156515926122665, 0.06117333471775055, 0.04895704984664917, -0.08716674894094467, -0.07123435288667679, 0.06320270150899887, -0.11756282299757004, -0.10578637570142746, 0.18885256350040436, -0.17525224387645721, 0.1253783255815506, -0.006149946711957455, -0.275496244430542, 0.03214927390217781, -0.09190399199724197, 0.21522918343544006, -0.14414745569229126, -0.19361554086208344, 0.005793217569589615, -0.036655861884355545, -0.019517621025443077, 0.09415359050035477, -0.03767602890729904, 0.06506793200969696, -0.12210571765899658, -0.34464290738105774, -0.05222218856215477, -0.03062220849096775, -0.04207560420036316, -0.05603121593594551, 0.011562949977815151, 0.14622314274311066, -0.10034722834825516, 0.11775563657283783, 0.08865762501955032, 0.10761109739542007, -0.02625320293009281, -0.1088075041770935, 0.18018624186515808, 0.105057492852211, -0.24528959393501282, -0.10347588360309601, 0.06454315781593323, 0.2813991606235504, 0.1541125774383545, -0.04559847339987755, 0.0390479601919651, -0.08375711739063263, 0.10899924486875534, -0.32864782214164734, 0.04239165037870407, 0.1313054859638214, 0.10788490623235703, 0.1227458044886589, 0.09072663635015488, -0.15892735123634338, 0.06629227101802826, 0.06422336399555206, -0.13669835031032562, -0.015917886048555374, 0.03480060398578644, -0.08512984961271286, 0.02860536240041256, -0.041131582111120224, 0.24887818098068237, 0.03799571841955185, -0.1352052241563797, -0.09624551236629486, 0.19629226624965668, -0.18503883481025696, -0.10390499234199524, 0.05946304649114609, -0.056296493858098984, -0.16661806404590607, -0.2842686176300049, -0.03535795956850052, 0.3140040636062622, 0.2158919870853424, -0.16504907608032227, 0.07304570823907852, -0.007711515761911869, -0.032053060829639435, 0.034228891134262085, 0.16445155441761017, -0.013852888718247414, 0.019792012870311737, -0.019853942096233368, -0.0006108339875936508, 0.2665952146053314, -0.03465386480093002, 0.0017979179974645376, 0.260084867477417, 0.019147954881191254, 0.02749667875468731, 0.007451485842466354, 0.06337335705757141, -0.034983012825250626, -0.007924404926598072, -0.10762432217597961, -0.0025871573016047478, -0.0314791277050972, 0.02237747795879841, 0.01123442966490984, 0.1589754819869995, -0.26329389214515686, 0.21334682404994965, -0.012974954210221767, -0.07321552187204361, 0.06457515060901642, 0.04728178679943085, -0.05814854055643082, -0.07704760879278183, 0.15378428995609283, -0.3043437898159027, 0.07191040366888046, 0.16878291964530945, 0.09168729186058044, 0.14019662141799927, -0.0001177620142698288, 0.06045279651880264, 0.01923784241080284, -0.1560412049293518, -0.16827496886253357, -0.10634513199329376, 0.031001120805740356, -0.07573352009057999, -0.09187111258506775, 0.0380566269159317]  
        }
      }
    }
  }
}
```

PUT /myindex
{
  "settings": {
    "index.knn": true
  },
  "mappings": {
    "properties": {
      "my_vector": {
        "type": "knn_vector",
        "dimension": 128
      }
    }
  }
}
